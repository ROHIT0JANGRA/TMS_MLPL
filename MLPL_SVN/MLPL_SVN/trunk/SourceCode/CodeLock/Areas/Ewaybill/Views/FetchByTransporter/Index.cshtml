@using Secure_Coding.MvcSecurityExtensions;
@{
    ViewBag.Title = "Insert";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<div class="widget-wrap">
    <div class="row container-fluid col-12 p-0 m-0 mb-4">
        <div class="form-group m-0 col-12 col-sm-6 col-md-3">
            <label class="form-label">State</label>
            <select class="form-select form-control" id="stateDropdown">
                <option value="">Select</option>
                @foreach (var state in Model.StateList)
                {
                    <option value="@state.StateId">@state.StateName</option>
                }
            </select>
        </div>
        <div class="form-group m-0 col-12 col-sm-6 col-md-3">
            <label for="exampleInputEmail1">Date</label>
            <input type="date" class="form-control" id="ewbDate">
        </div>
        <div class="form-group m-0 col-12 col-sm-6 col-md-3">
            <input type="button" class="btn btn-sm btn-primary" id="btnSendRequest" value="Get Detail" />
        </div>
        <div class="form-group m-0 col-12 col-sm-6 col-md-3">
            <button class="mt-3 btn btn-sm btn-primary" id="submitHiddenButton" style="display: none;">Submit</button>
        </div>

    </div>

    <div id="dvEwaybill" class="widget-wrap material-table-widget">

    </div>
</div>

@section scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

    <script>
        var rootObj;
        $(document).ready(function () {
            $("#submitHiddenButton").click(function () {
                submitDetail(rootObj);
            })
        })
        function submitDetail(rootObj) {
            console.log(rootObj);
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GetDataSubmit", "FetchByTransporter")',
                contentType: 'application/json',
                data: JSON.stringify( rootObj ),
                success: function (response) {
                    console.log("Data submitted successfully : ", response);
                    // Handle success response if needed
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error('Error:', errorThrown);
                    console.log('Error : ', errorThrown);
                    // Handle error response if needed
                }
            });
        }

        $(document).ready(function () {
            $("#btnSendRequest").click(function () {
                var stateDropdown = $("#stateDropdown").val();
                console.log(stateDropdown);
                var ewbDate = moment($('#ewbDate').val(), "YYYY-MM-DD", true).format("YYYYMMDD");

                console.log(ewbDate);
                if (stateDropdown && ewbDate && ewbDate != 'Invalid date') {
                    var url = '@Url.Action("GetData", "FetchByTransporter")'; // Corrected controller name
                    $.ajax({
                        type: "POST",
                        url: url,
                        data: JSON.stringify({ model: { StateId: stateDropdown, EwbDate: ewbDate } }), // Adjusted data structure
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (data) {
                            data = data;
                            console.log(data);
                            $("#submitHiddenButton").show();
                            rootObj = data[0];
                            EWBDetails = data[0].EWBDetails;
                            if (data.Error) {
                                alert(data.Error);
                                console.log(data.Error)
                            }
                            else {
                                var tableContent = '';
                                tableContent +=
                                `<table id="ewbDataTable" class="table table-responsive table-bordered table-striped display nowrap" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Party GSTIN</th>
                                            <th>EwayBill No</th>
                                            <th>Date</th>
                                            <th>Document No</th>
                                            <th>Valid Upto</th>
                                            <th>Delivery Place</th>
                                            <th>Del Pin</th>
                                            <th>Del State Code</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>`;

                                $("#dvEwaybill").html(tableContent);
                                $('#ewbDataTable').dataTable({
                                    data: EWBDetails, // Assuming 'value' is the array of objects in your JSON
                                    lengthMenu: [
                                        [5, 10, 20, 30], [5, 10, 20, 30]
                                    ],
                                    pageLength: 5,
                                    columns: [
                                        { data: 'genGstin' },
                                        { data: 'ewbNo' },
                                        { data: 'ewbDate' },
                                        { data: 'docNo' },
                                        { data: 'validUpto' },
                                        { data: 'delPlace' },
                                        { data: 'delPinCode' },
                                        { data: 'delStateCode' },
                                        { data: 'status' }
                                    ]
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.log(xhr.responseText);
                        }
                    });
                } else { alert('Ewaybill Date and State are both mandatory'); }
            });
        });
    </script>
}