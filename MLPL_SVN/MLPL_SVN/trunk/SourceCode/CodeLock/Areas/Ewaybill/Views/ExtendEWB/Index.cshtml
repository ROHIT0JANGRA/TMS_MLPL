@model IEnumerable<CodeLock.Models.EWBDetail>

@{
    ViewBag.Title = "E-way Bill Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="widget-wrap material-table-widget" style="padding:5px">
    <div class="container-fluid">
        <div class="card-body">
            <ul class="nav nav-tabs" id="ewayBillTab" role="tablist">
                <li class="nav-item active">
                    <a class="nav-link active" id="my-eway-bill-tab" data-toggle="tab" href="#my-eway-bill" role="tab" aria-controls="my-eway-bill" aria-selected="true">My Eway Bill</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="other-eway-bill-tab" data-toggle="tab" href="#other-eway-bill" role="tab" aria-controls="other-eway-bill" aria-selected="false">Eway Bills by other parties</a>
                </li>
            </ul>
            <div class="tab-content" id="ewayBillTabContent">
                <div class="tab-pane fade show active in" id="my-eway-bill" role="tabpanel" aria-labelledby="my-eway-bill-tab">
                    <div class="container-fluid row" style="padding-right: 0px;">
                        @if (ViewBag.ewbSummary != null)
                        {
                            <div class="col-12">
                                <b>Summary</b>
                            </div>
                            <div class="col-12 row">
                                <div class="col-3 col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                    Total : @ViewBag.ewbSummary[0].TotalCount
                                </div>
                                <div class="col-3 col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                    Active : @ViewBag.ewbSummary[0].Active
                                </div>
                                <div class="col-3 col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                    Expiring Today : @ViewBag.ewbSummary[0].TodayExpire
                                </div>
                                <div class="col-3 col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                    Expire Tomorrow : @ViewBag.ewbSummary[0].TomorrowExpire
                                </div>
                                <div class="col-3 col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                    Expired : @ViewBag.ewbSummary[0].Expired
                                </div>
                                <div class="col-3 col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                    Date Undefined : @ViewBag.ewbSummary[0].UndefinedDate
                                </div>
                            </div>
                        }
                        else
                        {
                            <p>No Summary data available</p>
                        }
                    </div>

                    <div class="row">
                        <div class="table-sm table-responsive">
                            <table id="dtParts" class="table table-responsive table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Eway Bill No.</th>
                                        <th>Eway Bill Date</th>
                                        <th>Valid till</th>
                                        <th>Doc No.</th>
                                        <th>From GSTIN</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Add more rows as needed -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="other-eway-bill" role="tabpanel" aria-labelledby="other-eway-bill-tab">
                    <div class="container-fluid row">
                        <div class="">
                            <b>No data available in table</b>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function () {
    SetPageLoad('Ewaybill', 'List', 'filter');
    // Destroy any existing DataTable instance to avoid reinitialization error
    if ($.fn.DataTable.isDataTable('#dtParts')) {
        $('#dtParts').DataTable().destroy();
    }

    $('#dtParts').DataTable({

        clear: true,
        destroy: true,
        serverSide: true,
        searchable: true,
        pageLength: 5,
        lengthMenu: [[5, 10, 25, 50, 100], [5, 10, 25, 50, 100]],
        autoFill: false,
        "initComplete": function (settings, json) {
            $(this.api().table().container()).find('input').attr('autocomplete', 'off');
        },
        "language": {
            "emptyTable": "No record found.",
            "processing":
                '<i class="fa fa-spinner fa-spin fa-3x fa-fw" style="color:#2a2b2b;"></i><span class="sr-only">Loading...</span> '
        },
        ajax:
        {
            // Add your URL for fetching data via AJAX
            url: '@Url.Action("GetAllEwaybillDetailByPagination", "ExtendEWB")',
            // Add any additional data parameters if needed
            type: "POST",
            contentType: "application/json; charset=utf-8",
            data: function (d) {
                var data = { data: d };
                return JSON.stringify(data);
            },
            AutoWidth: false,
            "dataSrc": function (json) {
                console.log("json : ", json);
                var data = json;
                json.draw = data.draw;
                json.recordsTotal = data.recordsTotal;
                json.recordsFiltered = data.recordsFiltered;
                json.data = JSON.parse(data.data);
                return json.data;
            }
        },
        // Define column configurations
        columns: [
            { "data": "ewbNo", name: "ewbNo", "autowidth": true },
            { "data": "ewbDate", name: "ewbDate", "autowidth": true },
            { "data": "validUpto", name: "validUpto", "autowidth": true },
            { "data": "docNo", name: "docNo", "autowidth": true },
            { "data": "genGstin", name: "genGstin", "autowidth": true },
            {
                render: function (data, type, row, meta) {
                    console.log($`dataObject : { ${row.ewbNo}, ${row.validUpto}, ${row.IsExtend}`);
                    if (row.IsExtend) {
                        return `<a class="btn btn-default btn-sm m-user-edit" data-ewbno="${row.ewbNo}">Extend</a>`;
                    } else {
                        return `<div class="" data-ewbno="${row.ewbNo}"></div>`;
                    }
                    // return '<a class="btn btn-default btn-sm m-user-edit" href="@Url.Action("Extend")/' + row.ewbNo + '"><span class="zmdi zmdi-more-vert"></span></a>';
                }
            }
        ],
        // Define columnDefs for additional configuration
        columnDefs: [
            {
                targets: [0],
                searchable: false
            }
        ]
    });
});

$(document).ready(function () {
    $('#dtParts').on('click', '.m-user-edit', function (e) {
        console.log("clicked on the button");
        e.preventDefault();
        var ewbNo = $(this).data('ewbno');
        console.log('ewbNo : ', ewbNo);

        Swal.fire({
            title: "Are you sure?",
            text: "You want to extend this Ewaybill!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, extend it!"
        }).then((result) => {
            if (result.isConfirmed) {
                extendEwaybill(ewbNo); // Call the function to perform AJAX request
            }
        });
    });
});

function extendEwaybill(ewbNo) {
    $.ajax({
        url: '@Url.Action("Extend", "ExtendEWB")',
        type: 'POST', // or 'GET' depending on your server-side method
        data: { ewbNo: ewbNo },
        dataType: 'json', // Change this based on your server response type
        success: function (response) {
            Swal.fire({
                title: "Extended!",
                text: "Your ewaybill has been extended.",
                icon: "success"
            }).then(() => {
                // Optionally, update the UI or redirect to another page
                location.reload(); // Example: Refresh the page
            });
        },
        error: function (xhr, status, error) {
            Swal.fire({
                title: "Error!",
                text: "Failed to extend ewaybill. Please try again.",
                icon: "error"
            });
        }
    });
}

</script>