@model IEnumerable<CodeLock.Models.ReportTripStartModel>
@using CodeLock.Models;
@{
    ViewBag.Title = "TripSheetReport";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<script src="https://cdnjs.cloudflare.com/ajax/libs/TableExport/5.2.0/js/tableexport.min.js"></script>
@*=----------------------------------------------------------------------------------------------------------*@

<style>
    /* Ensure the table is scrollable horizontally */
    .table-responsive {
        overflow-x: auto;
    }

    /* Add hover effect to table rows */
    .table tbody tr:hover {
        background-color: #f5f5f5; /* Light gray background on hover */
        cursor: pointer; /* Change cursor to pointer on hover */
    }
</style>


@* =========================================================================================================================================*@


@using (Html.BeginForm("TripSheetReport", "Analysis", FormMethod.Post, new { @class = "j-forms", id = "reportForm" }))
{

    //==========================================================================================================================================
    <div class="widget-wrap">
        <div class="widget-header">
            <h3> TripSheet Start Report</h3>
            <button type="submit" id="btnSubmit" class="btn btn-primary primary-btn" tabindex="3">View Report</button>
            <button type="button" id="btnExcel" class="btn btn-default compose-btn" tabindex="3">Export Excel</button>

        </div>

        <div class="row">
            <div class="col-sm-2">
                <div class="form-group">
                    @Html.Label("Tripsheet Date", new { @class = "label" })
                    <div class="clearfix">
                        <div id="drDate"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="form-group">
                    @Html.Label("Company", new { @class = "CompanyId" })
                    @Html.DropDownList("CompanyId", new List<SelectListItem>
                    {
                        new SelectListItem { Text = "Mahalakshmi Logistic Pvt LTD", Value = "1" },

                        // Add more SelectListItem objects as needed
                    }, "Select a Company", new { @class = "form-control", id = "CompanyId" })
                </div>
            </div>
            <div class="col-sm-3">
                @Html.Partial("LocationHierarchy", new LocationHierarchy() { FieldName = "FromLocationID", FieldCaption = "From Location" })
            </div>
            <div class="col-sm-3">
                @Html.Partial("LocationHierarchy", new LocationHierarchy() { FieldName = "ToLocationId", FieldCaption = "To Location", AllowAll = true })
            </div>
            <div class="col-sm-1">
                <label class="checkbox" style="margin-top:25px;"><label for="chkAll" class="label">All Check</label><input type="checkbox" id="chkAll"><i></i></label>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12" id="dvCheckbox"></div>
        </div>
    </div>
    <div class="report-container table-responsive">
        <table id="dtCustomer" class="table table-bordered table-striped">
            <thead class="bg-primary">
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <h4 class="text-danger">@ViewBag.Error</h4>


    <script>

        var baseUrl, dvFieldCheckboxContainer, columnsToDisplay = ["SRNo", "TripsheetNo", "TripsheetDate", "TripsheetTime", "ManualTripsheetNo", "StartLocation", "EndLocation",
            "VehicleNo", "StartKm", "FromCity", "ToCity", "EntryBy", "EntryDate"];
        $(document).ready(function () {
         baseUrl = '@Url.Action("", "Analysis", new { Area = "Reports" })';
            $("#CompanyId").val(1);
    // Initialize date range picker
    $('#drDate').daterangepicker();
    InitDateRange('drDate', DateRange.LastWeek);
    // Function to generate custom filename
    function getFilename() {
        var currentDate = new Date();
        var dateString = currentDate.getFullYear() + '-' + (currentDate.getMonth() + 1) + '-' + currentDate.getDate();
        return 'DRSReport_' + dateString;
    }
            GetDocketFieldList();
            updateColumnsToDisplay();

    $("#chkAll").on("click", function () {
        if ($("#chkAll").is(':checked')) {
            $('.CheckedFieldNames').prop("checked", true);
        }
        else {
            $('.CheckedFieldNames').prop("checked", false);
        }
        updateColumnsToDisplay();
    });
    $('.CheckedFieldNames').change(function () {
        updateColumnsToDisplay();
        // You can use columnsToDisplay array here as needed
    });
    $('#reportForm').submit(function(e) {
        e.preventDefault(); // Prevent default form submission

        // Get date range from the picker
        var fromDate = $('#drDate').data('daterangepicker').startDate.format('DD-MM-YYYY');
        var toDate = $('#drDate').data('daterangepicker').endDate.format('DD-MM-YYYY');

        // Get other form data
        var fromLocationID = $('#ddlFromLocationID').val();
        var toLocationId = $('#ddlToLocationId').val();
        var companyId = $('#CompanyId').val();
        if (companyId == "") {
            companyId = 0;
        }
        var CheckedFieldNames = '';
        fetchData('fromDate=' + fromDate + '&toDate=' + toDate + '&FromLocationID=' + fromLocationID + '&ToLocationId=' + toLocationId + '&CompanyId=' + companyId + '&CheckedFieldNames=' + CheckedFieldNames);
    });

    $('#btnExcel').click(function () {
        var filename = getFilename(); // Get the custom filename
        // Check if the table has data before exporting
        if ($('#dtCustomer tbody tr').length > 0) {
            // Export table to Excel format
            $('#dtCustomer').tableExport({
                type: 'excel',
                escape: 'false',
                fileName: filename // Use fileName instead of filename
            });
        } else {
            alert("List Is Empty");
        }
    });

    function fetchData(formData) {
        if (columnsToDisplay.length <= 1) {
            alert("Please check atleast one checkbox of column ..!")
        }
        else {
            $.ajax({
                url: '@Url.Action("GetTripStartReports", "Analysis")',
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: function (response) {
                    console.log(response);

                    // Clear previous table data
                    $('#dtCustomer thead').empty();
                    $('#dtCustomer tbody').empty();

                    // Check if response data is not empty
                    if (response && response.length > 0) {
                        var columns = Object.keys(response[0]);
                        // Create table headers
                        var headerRow = '<tr>';
                        columnsToDisplay.forEach(function (column) {
                            headerRow += '<th>' + column + '</th>';
                        });
                        headerRow += '</tr>';
                        $('#dtCustomer thead').append(headerRow);
                        response.forEach(function (item) {
                            var row = '<tr>';
                            columnsToDisplay.forEach(function (column) {
                                if (item[column] == null) {
                                    row += '<td></td>';
                                } else {
                                    row += '<td>' + item[column] + '</td>';
                                }
                            });
                            row += '</tr>';
                            $('#dtCustomer tbody').append(row);
                        });
                    } else {
                        // If response data is empty, display a message or handle it accordingly
                        $('#dtCustomer tbody').append('<tr><td colspan="0">No data available</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                }
            });
        }
    }
});
function GetDocketFieldList() {
    var requestData = { FormName: "TripStartReport" };
    AjaxRequestWithPostAndJson(baseUrl + '/GetColumnListByReport', JSON.stringify(requestData), function (result) {
        if (result.length == 0)
            $("#dvCheckbox").empty();
        else {
            $("#dvCheckbox").empty();
            var content = '';
            debugger;
            $.each(result, function (index, value) {
                content += "<div class='col-sm-3'> <label class='checkbox'>" +
                    '<label for = "chkDocketField' + index + '" class="label">' + value.FieldCaption.replace(/\s+/g, '') + '</label>' +
                    '<input type="checkbox"  id="chkField' + index + '" value="' + value.FieldName.replace(/\s+/g, '') + '" class="CheckedFieldNames"/><i></i>' +
                    //'<input type="hidden" id="hdnFieldId' + index + '" value = ' + value.FieldId + ' />' +
                    '</label></div>'
            });
            $("#dvCheckbox").html(content);
            var valueToCheck = ["SRNo", "TripsheetNo", "TripsheetDate", "TripsheetTime", "ManualTripsheetNo", "StartLocation", "EndLocation",
                "VehicleNo", "StartKm", "FromCity", "ToCity", "EntryBy", "EntryDate"];
            $(".CheckedFieldNames").each(function () {
                var checkboxValue = $(this).val();
                if ($.inArray(checkboxValue, valueToCheck) !== -1) {
                    $(this).prop("checked", true);  // Check the checkbox
                } else {
                    $(this).prop("checked", false);
                }
            });
            $("#dvCheckbox").show();
        }
    }, ErrorFunction, false);
}
function updateColumnsToDisplay() {
    columnsToDisplay = ["SRNo"];
    $('.CheckedFieldNames:checked').each(function () {
        columnsToDisplay.push($(this).val());

    });
}
    </script>

}



<style>
    .report-container {
        overflow-x: auto;
        overflow-y: auto;
        white-space: nowrap; /* Prevent wrapping of table cells */
        max-width: 100%; /* Ensure the table doesn't exceed its container */
        max-height: auto; /* Adjust max-height as needed */
    }

        .report-container table {
            min-width: 100%; /* Ensure table takes full width of its container */
        }
</style>
